<!doctype html>
<html>
<head>
    <title>CareQ Admin Dashboard</title>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        h1 { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 2.5em;
            font-weight: 800;
        }
        .patient-card { 
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 15px;
            padding: 20px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .patient-card.called { 
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
            border-color: #28a745; 
        }
        .patient-info { flex-grow: 1; }
        .patient-info h3 { margin: 0 0 5px 0; color: #0056b3; }
        .patient-info p { margin: 0; font-size: 0.9em; }
        .actions button { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            margin-left: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .actions button.pdf { 
            background: linear-gradient(135deg, #007bff, #6610f2); 
        }
        .actions button.reset { 
            background: linear-gradient(135deg, #dc3545, #e83e8c); 
        }
        .actions button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .controls { 
            text-align: center; 
            margin-bottom: 30px; 
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .controls button { 
            padding: 15px 30px; 
            background: linear-gradient(135deg, #17a2b8, #20c997); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .controls button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
        }
        .controls a {
            padding: 15px 30px; 
            background: linear-gradient(135deg, #6c757d, #495057); 
            color: white; 
            text-decoration: none; 
            border-radius: 10px; 
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
        }
        .controls a:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CareQ Admin Dashboard</h1>
        <div class="controls">
            <button onclick="fetchPatients()">Refresh Queue</button>
            <a href="/" style="margin-left: 10px; padding: 10px 20px; background-color: #17a2b8; color: white; text-decoration: none; border-radius: 5px;">‚Üê Home</a>
        </div>
        <div id="patient-list"></div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000"; // Replace with your backend API URL if different

        async function fetchPatients() {
            const response = await fetch(`${API_URL}/patients/`);
            const patients = await response.json();
            renderPatients(patients);
        }

        function renderPatients(patients) {
            const patientListDiv = document.getElementById("patient-list");
            patientListDiv.innerHTML = '';
            if (patients.length === 0) {
                patientListDiv.innerHTML = '<p style="text-align: center;">No patients in queue.</p>';
                return;
            }
            patients.forEach(patient => {
                const card = document.createElement("div");
                card.className = `patient-card ${patient.called ? 'called' : ''}`;
                card.innerHTML = `
                    <div class="patient-info">
                        <h3>Token: ${patient.id} - ${patient.name} (${patient.age})</h3>
                        <p>Symptoms: ${patient.symptoms.join(', ')}</p>
                        <p>Severity: ${patient.severity_level} | ETA: ${patient.eta} mins</p>
                        <p>Queued At: ${new Date(patient.queued_at).toLocaleString()}</p>
                    </div>
                    <div class="actions">
                        ${!patient.called ? `<button onclick="callPatient(${patient.id})">Call Next</button>` : `<button class="reset" onclick="resetPatient(${patient.id})">Reset</button>`}
                        <button class="pdf" onclick="generatePdf(${patient.id})">Generate PDF</button>
                    </div>
                `;
                patientListDiv.appendChild(card);
            });
        }

        async function callPatient(patientId) {
            await fetch(`${API_URL}/patients/${patientId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ called: true })
            });
            fetchPatients();
        }

        async function resetPatient(patientId) {
            await fetch(`${API_URL}/patients/${patientId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ called: false })
            });
            fetchPatients();
        }

        async function generatePdf(patientId) {
            const response = await fetch(`${API_URL}/generate_token_pdf/${patientId}`);
            const result = await response.json();
            if (response.ok) {
                alert(result.message + ` File: ${result.file_path}`);
                // In a real app, you might provide a link to download the PDF
            } else {
                alert("Failed to generate PDF: " + result.detail);
            }
        }

        // Initial fetch when page loads
        fetchPatients();
        // Refresh every 30 seconds
        // setInterval(fetchPatients, 30000);

        // WebSocket for real-time updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === "queue_update") {
                renderPatients(data.patients);
            }
        };

        ws.onopen = function(event) {
            console.log("WebSocket connection opened:", event);
        };

        ws.onclose = function(event) {
            console.log("WebSocket connection closed:", event);
            // Optionally try to reconnect after a delay
        };

        ws.onerror = function(error) {
            console.error("WebSocket error:", error);
        };
    </script>
</body>
</html>
